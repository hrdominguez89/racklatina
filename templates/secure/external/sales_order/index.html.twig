{% extends 'base.html.twig' %}
{% block title %}
    Ordenes de compra
{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('Datatables/datatables.min.css') }}">
    {% endblock %}
    {% block body %}
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item">
                                    <a href="{{ path('app_home') }}">
                                        Mi portal
                                    </a>
                                </li>
                                <li class="breadcrumb-item active">
                                    Ordenes de compra
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
                {% for message in app.flashes('info') %}
                    <div class="alert alert-info">{{ message }}</div>
                {% endfor %}
            </div>
          <form method="GET">
            <div class="row">
                <!-- Columna del selector de cliente -->
                <div class="col-12 col-md-5">
                    <label class="form-class">Seleccione un cliente:</label>
                    <select class="form-select" name="Cliente" id="Cliente">
                        <option value=0>Seleccione un cliente</option>
                        {% for cliente in clientes %}
                        <option value="{{cliente.codigoCalipso}}" {{ app.request.get('Cliente') == cliente.codigoCalipso ? 'selected' : ''}}>{{cliente.razonsocial}}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Columna de búsqueda por artículos -->
                {% if mostrar_opciones_articulos %}
                <div class="col-12 col-md-3 offset-md-2">
                    <label class="form-class">Buscar por artículos(opcional)</label>
                    <div class="d-flex gap-2">
                        <input 
                            type="text" 
                            name="Articulo_seleccionado" 
                            class="form-control"
                            list="listado-de-articulos"
                        >
                        <datalist id="listado-de-articulos">
                            {% for articulo in articulos %}
                            <option value="{{articulo["articulo"]}}" {{ app.request.get('Articulo_seleccionado') == articulo["articulo"] ? 'selected' : ''}}>{{articulo["articulo"]|slice(2)}}</option>
                            {% endfor %}
                        </datalist>
                        <button 
                            type="button" 
                            class="btn btn-primary flex-shrink-0" 
                            id="btn-buscar-articulo"
                        >
                            <i class="ri-search-line"></i> 
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="mb-4"></div>
        </form>
        {% if mostrar_tablas %}
            <div class="row">
                <div class="col-12 d-flex justify-content-start align-items-start mb-6"  >
                    <div>
                        <a href="{{ path('app_secure_external_sales_order_sales_order',{status:'Todas',Cliente: cliente  }) }}"
                        class="btn {{ status=='Todas'? 'active':'' }} btn-outline-primary">
                            Todas
                        </a>
                        <a href="{{ path('app_secure_external_sales_order_sales_order',{status:'Pendiente',Cliente: cliente }) }}" 
                        class="btn {{ status=='Pendiente'? 'active':'' }} btn-outline-primary">
                            Pendiente
                        </a>
                        <a href="{{ path('app_secure_external_sales_order_sales_order',{status:'Remitido',Cliente: cliente  }) }}"
                        class="btn {{ status=='Remitido'? 'active':'' }} btn-outline-primary">
                            Remitido
                        </a>
                        <a href="{{ path('app_secure_external_sales_order_sales_order', {
                                'status': 'articulos_pendientes',Cliente: cliente 
                            }) }}" class="btn {{ status=='articulos_pendientes'? 'active':'' }} btn-outline-primary">
                            Artículos pendientes
                        </a>
                    </div>
                </div>
            </div><!--ROW DE FILTROS-->
            
            <div class="row mt-4">
                <div class="col-12">
                    {% if app.request.get('status') != 'articulos_pendientes' %}
                    <table id="tabla-pedidos" class="table table-striped">
                        <thead>
                            <tr>
                                <th style="text-align: center;">Orden Compra Cliente</th>
                                <th style="text-align: center;">Nro pedido</th>
                                <th style="text-align: center;">Razón Social</th>
                                <th style="text-align: center;">Fecha Pedido</th>
                                <th style="text-align: center;">Estado</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pedido in pedidos %}
                                <tr>
                                    <td style="text-align: center;">{{ pedido.ordencompracliente }}</td>
                                    <td style="text-align: center;">{{ pedido.numero }}</td>
                                    <td style="text-align: center;">{{ pedido.razonsocial }}</td>
                                    {% set fecha_visible = pedido.fechaoc ? pedido.fechaoc : null  %}
                                    {% if fecha_visible %}
                                        {% set fecha = fecha_visible|split('/') %}
                                        {% set fecha_ordenada = fecha[2] ~ '/' ~ fecha[1] ~ '/' ~ fecha[0] %}
                                        <td style="text-align: center;" data-order="{{ fecha_ordenada }}"> {{fecha_visible}}</td>
                                    {% else %}
                                        <td style="text-align: center;" data-order="9999-12-31"></td>
                                    {% endif %}
                                    <td style="text-align: center;">
                                        {% if status == 'Todas' %}
                                            Pendientes&nbsp;{{ pedido.pendientes }}&nbsp;/Remitidos&nbsp;{{ pedido.remitidos }}
                                        {% elseif status == 'Pendiente' %}
                                            Pendientes&nbsp;
                                            {{ pedido.pendientes }}
                                        {% elseif status == 'Remitido' %}
                                            Remitidos&nbsp;
                                            {{ pedido.remitidos }}
                                        {% endif %}
                                    </td>
                                    <td style="text-align: center;">
                                        <a style="text-align: center;" href="{{ path('app_secure_external_sales_order_sales_order_ver_en_detalle', {'numero_pedido':pedido.numero,'cliente_id': pedido.cliente, 'orden_compra_cliente_id': pedido.ordencompracliente,status:app.request.get('status') ? app.request.get('status'):'Todas'}) }}" class="btn btn-outline-primary btn-sm">
                                            Detalle
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <table id="tabla-pedidos" class="table table-striped">
                            <thead>
                                <tr>
                                    <th style="text-align: center;">Orden de compra</th>
                                    <th style="text-align: center;">Código de artículo</th>
                                    <th style="text-align: center;">Cantidad pendiente</th>
                                    <th style="text-align: center;">Número de pedido</th>
                                    <th style="text-align: center;">Detalle</th>
                                    <th style="text-align: center;">Fecha estimada</th>
                                    <th style="text-align: center;">Fecha de pedido</th>
                                    <th style="text-align: center;">Ver O.C. detalle</th>
                                </tr>
                            </thead>
                            <tbody> 
                                {% for articulo in pedidos %}

                                    <tr>
                                        <td style="text-align: center;">{{ articulo.ordencompracliente}}</td>
                                        <td style="text-align: center;">{{ articulo.articulo |slice(2) }}</td>
                                        <td style="text-align: center;">{{ articulo.cantidadPendiente }}</td>
                                        <td style="text-align: center;">{{ articulo.numero }}</td>
                                        <td style="text-align: center;">{{ articulo.detalle }}</td>
                                        {% set fecha_visible = articulo.fechaentrega ? articulo.fechaentrega : (articulo.fechaEstimada ?? '') %}
                                        {% set hoy = 'now'|date('Y-m-d') %}
                                        {% if fecha_visible %}
                                            {% set fecha = fecha_visible|split('/') %}
                                            {% set fecha_ordenada = fecha[2] ~ '/' ~ fecha[1] ~ '/' ~ fecha[0] %}
                                            {% set fecha_iso = fecha[2] ~ '-' ~ fecha[1] ~ '-' ~ fecha[0] %}
                                            {% if fecha_iso < hoy and articulo.estado != "Remitido" %}
                                                <td  class="bg-primary" data-order="{{ fecha_ordenada }}" style="text-align: center;">
                                                    <button type="button"  class="btn btn-light btn-sm" id="{{ loop.index0 }}" name="Contactar-por-vencimiento" >
                                                        <i class="ri-mail-line"></i> Contactar
                                                    </button>
                                                </td>
                                            {% else %}
                                                <td class="bg-primary" data-order="{{ fecha_ordenada }}" style="text-align: center;">
                                                    {{ fecha_visible }}
                                                </td>
                                            {% endif %}
                                        {% else %}
                                            <td data-order="9999-12-31" style="text-align: center;">Sin fecha</td>
                                        {% endif %}
                                        <td style="text-align: center;">{{ articulo.fechapedido|date('d/m/Y') }}</td>
                                        <td style="text-align: center;">
                                            <a href="{{ path('app_secure_external_sales_order_sales_order_ver_en_detalle',
                                             {'numero_pedido':articulo.numero,
                                             'cliente_id': articulo.cliente, 
                                             'orden_compra_cliente_id': articulo.ordencompracliente,
                                             status:app.request.get('status') ? app.request.get('status'):'Todas',
                                             search: app.request.get('search'),searchType: app.request.get('searchType')}) }}"
                                            class="btn btn-outline-primary btn-sm">
                                                Detalle
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                    </table>
                    {% endif %}
                </div>
            </div> <!--ROW DE TABLAS-->
        {% endif %}
            <div class="row mt-4"> <!-- VOLER-->
                <div class="col-12 text-end">
                    <a class="btn btn-secondary" href="{{ path('app_home') }}">
                        Volver
                    </a>
                </div>
            </div>
            </div>
    {% endblock %}
    {% block javascripts %}
        {{ parent() }}
        <script src="{{ asset('js/jquery-3.7.1.min.js') }}"></script>
        <script src="{{ asset('Datatables/datatables.min.js') }}"></script>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selectCliente = document.getElementById('Cliente');
            if (selectCliente) {
                selectCliente.addEventListener('change', function() {
                    if (this.value != 0) {
                        this.form.submit();
                    }
                });
            }
        
            const arrayDeContactos = document.querySelectorAll('[name="Contactar-por-vencimiento"]');
            arrayDeContactos.forEach(contacto => {
                contacto.addEventListener('click',function()
                {
                    const index = parseInt(contacto.id, 10);
                    const orden_de_compra = {{ pedidos|default([])|json_encode|raw }};
                    const data = orden_de_compra[index].ordencompracliente + " articulo " + orden_de_compra[index].articulo;
                    abrirModalContacto(data);
                });
            }
            );

            const btnArticulo = document.getElementById('btn-buscar-articulo');
            const inputArticulo = document.querySelector('input[name="Articulo_seleccionado"]');
            
            if (btnArticulo && inputArticulo) {
                btnArticulo.addEventListener('click', function() {
                    const valorArticulo = inputArticulo.value.trim();
                    
                    if (valorArticulo !== '') {
                        const url = new URL(window.location);
                        
                        
                        url.searchParams.set('Articulo_seleccionado', valorArticulo);
                        
                        
                        const clienteSeleccionado = selectCliente ? selectCliente.value : null;
                        if (clienteSeleccionado && clienteSeleccionado != 0) {
                            url.searchParams.set('Cliente', clienteSeleccionado);
                        }
                        
                        
                        const statusActual = new URLSearchParams(window.location.search).get('status');
                        if (statusActual) {
                            url.searchParams.set('status', statusActual);
                        }
                        
                        
                        window.location.href = url.toString();
                    } else {
                        alert('Por favor, selecciona o escribe un artículo');
                    }
                });
                
                
                inputArticulo.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        btnArticulo.click();
                    }
                });
            }

            $('#tabla-pedidos').DataTable({
                language: { url: esDatatable },
                stateSave: true,
                order: [[3, 'desc']],
                colReorder: true,
                buttons: ['colvis', {
                    extend: 'excelHtml5',
                    title: 'Items pendientes',
                    filename: 'Items pendientes'
                }],
                dom: "<'row mb-3'<'col-sm-12 col-md-4'l><'col-sm-12 col-md-4 text-center'B><'col-sm-12 col-md-4'f>>" +
                    "<'row'<'col-sm-12'tr>>" +
                    "<'row mt-3'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>"
            });
        });
        function abrirModalContacto(data)
        {
            // Marcar que no se debe limpiar automáticamente
            window.noLimpiarModal = true;

            let mensaje = "Quiero saber el estado de mi pedido " + data;
            // Limpiar el div de asunto
            //$('#contactoModal #div-asunto').empty();

            // Configurar el select de asunto
            const selectHTML = `
                <label>Asunto:</label>
                <select name="asunto" id="asunto" class="form-select">
                    <option value="pedido_atrasado" selected>Pedido atrasado</option>
                </select>`;

            $('#contactoModal #div-asunto').html(selectHTML);

            // Configurar el mensaje
            $('#contactoModal #mensaje').val(mensaje);

            // Mostrar el modal
            $('#contactoModal').modal('show');
        }
        </script>
    {% endblock %}